description: Unsupervised QA on SQuAD v1.1

auth:
  vc: nextmsra
  cluster: eu1
  docker:
    #image: pytorch/pytorch:1.0-cuda10.0-cudnn7-devel
    registry: phillyregistry.azurecr.io
    #image: philly/jobs/custom/pytorch_with_bert:py36_cuda9.2
    image: philly/jobs/custom/pytorch_with_bert:py36_cuda10

code:
  local_dir: $CONFIG_DIR/../

storage:
  _default:
    storage_account_name: conversationhub
    container_name: unilm
    mount_path: /mnt/unilm
  _output:
    storage_account_name: conversationhub
    container_name: unilm
    mount_path: /mnt/outputs

search:
  job_template:
    #name: model_lv-{lv}_tm-{tm}_lr-{lr}_epoch-{epochs}
    name: model_tf-{tf}_md-{md}_lr-{lr}_epoch-{epochs}_seed-{sd}_onu-{onu}

    sku: G4
    command:
    - pip install --user pytorch-transformers; python -m torch.distributed.launch --nproc_per_node=4 run_squad_new.py 
        --model_type bert 
        --model_name_or_path /mnt/unilm/hanbao/exp/UQA/model/bert-large-wwm-uqa
        --do_train
        --do_lower_case 
        --train_file /mnt/unilm/hanbao/exp/UQA/data/tmp/{tf}_{md}_train-natural_unilm_qg_wikiref_data{onu}.json
        --predict_file /mnt/unilm/hanbao/exp/UQA/data/dev-v1.1.json 
        --learning_rate {lr} 
        --num_train_epochs {epochs}
        --max_seq_length 384 
        --doc_stride 128 
        --output_dir [PT_OUTPUT_DIR] 
        --per_gpu_train_batch_size=6   
        --fp16
        --seed {sd}
        --logging_steps 1000
        --save_steps 1000
        --overwrite_output_dir ;
      python run_squad_new.py 
        --model_type bert 
        --model_name_or_path bert-large-uncased-whole-word-masking 
        --do_eval
        --do_lower_case 
        --train_file /mnt/unilm/hanbao/exp/UQA/data/tmp/{tf}_{md}_train-natural_unilm_qg_wikiref_data{onu}.json
        --predict_file /mnt/unilm/hanbao/exp/UQA/data/dev-v1.1.json 
        --max_seq_length 384 
        --doc_stride 128 
        --output_dir [PT_OUTPUT_DIR] 
        --per_gpu_eval_batch_size=6   
        --fp16
        --eval_all_checkpoints
    submit_args:
      queue: bonus
  type: grid
  max_trials: 100
  params:
    - name: tf
      spec: discrete
      values: ['1']
    - name: md
      spec: discrete
      values: ['sc3']
    - name: lr
      spec: discrete
      values: [3e-5]
    - name: epochs
      spec: discrete
      values: [2.0]
    - name: sd
      spec: discrete
      values: [17, 42]
    - name: onu
      spec: discrete
      values: [''] #['.a1.inv','.a2.inv','.a3.inv']
      #values: ['.ne.a2.reg','.na.a2.reg','.ne.a3.reg','.na.a3.reg']
      #values: ['.a1.keep', '.a2.keep', '.a3.keep', '.a1.reg', '.a2.reg', '.a3.reg']
    

